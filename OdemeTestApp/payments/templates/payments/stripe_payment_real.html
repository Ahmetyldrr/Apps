{% extends 'payments/base.html' %}

{% block title %}Stripe ile Ödeme - {{ product.name }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="fab fa-stripe"></i> Stripe ile Ödeme
                </h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>Sipariş Detayları</h5>
                        <hr>
                        <p><strong>Ürün:</strong> {{ product.name }}</p>
                        <p><strong>Tutar:</strong> ₺{{ product.price }}</p>
                        <p><strong>Sipariş No:</strong> {{ order.order_id }}</p>
                    </div>
                    <div class="col-md-6">
                        <h5>Ödeme Bilgileri</h5>
                        <hr>
                        <!-- Stripe Elements burada render edilecek -->
                        <div id="payment-element">
                            <!-- Stripe Elements will create form elements here -->
                        </div>
                        <div id="payment-message" class="hidden"></div>
                    </div>
                </div>
                
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle"></i>
                    {% if payment_method.test_mode %}
                        <strong>Test Modu:</strong> Bu gerçek bir ödeme değildir. Test kartı: 4242424242424242
                    {% else %}
                        <strong>Güvenli Ödeme:</strong> Tüm ödemeler SSL ile korunmaktadır.
                    {% endif %}
                </div>
                
                <div class="d-flex justify-content-between">
                    <a href="{% url 'payments:product_detail' product.id %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Geri
                    </a>
                    <button id="submit-button" class="btn btn-success btn-lg">
                        <i class="fas fa-credit-card"></i> ₺{{ product.price }} Öde
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>

<script>
// Stripe konfigürasyonu
const stripe = Stripe('{{ stripe_publishable_key }}');

let elements;
let paymentElement;

initialize();

// Payment Element oluştur
async function initialize() {
    const { error } = await stripe.createPaymentElement({
        mode: 'payment',
        amount: {{ order.amount|floatformat:0 }}00, // Kuruş cinsinden
        currency: 'try',
        appearance: {
            theme: 'stripe',
            variables: {
                colorPrimary: '#0570de',
                colorBackground: '#ffffff',
                colorText: '#30313d',
                colorDanger: '#df1b41',
                fontFamily: 'Ideal Sans, system-ui, sans-serif',
                spacingUnit: '2px',
                borderRadius: '4px',
            }
        },
    });

    elements = stripe.elements({
        clientSecret: '{{ client_secret }}'
    });

    paymentElement = elements.create('payment');
    paymentElement.mount('#payment-element');
}

// Ödeme formunu handle et
document.getElementById('submit-button').addEventListener('click', handleSubmit);

async function handleSubmit(e) {
    e.preventDefault();
    setLoading(true);

    const { error } = await stripe.confirmPayment({
        elements,
        confirmParams: {
            return_url: window.location.origin + '{% url "payments:success" order.order_id %}',
            receipt_email: 'customer@example.com', // Müşteri emaili
        },
    });

    if (error) {
        if (error.type === "card_error" || error.type === "validation_error") {
            showMessage(error.message);
        } else {
            showMessage("Beklenmedik bir hata oluştu.");
        }
    }

    setLoading(false);
}

// UI helper functions
function showMessage(messageText) {
    const messageContainer = document.querySelector("#payment-message");
    messageContainer.classList.remove("hidden");
    messageContainer.textContent = messageText;
    messageContainer.className = "alert alert-danger";

    setTimeout(function () {
        messageContainer.classList.add("hidden");
        messageContainer.textContent = "";
    }, 4000);
}

function setLoading(isLoading) {
    const submitButton = document.querySelector("#submit-button");
    if (isLoading) {
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> İşleniyor...';
    } else {
        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="fas fa-credit-card"></i> ₺{{ product.price }} Öde';
    }
}

// Stripe Elements stillendirme
const appearance = {
    theme: 'stripe',
    variables: {
        colorPrimary: '#0570de',
        colorBackground: '#ffffff',
        colorText: '#30313d',
        colorDanger: '#df1b41',
        fontFamily: 'Ideal Sans, system-ui, sans-serif',
        spacingUnit: '2px',
        borderRadius: '4px',
    }
};
</script>

<style>
.hidden {
    display: none;
}

#payment-element {
    margin-bottom: 24px;
}

/* Stripe Elements customization */
.StripeElement {
    box-sizing: border-box;
    height: 40px;
    padding: 10px 12px;
    border: 1px solid #e1e5e9;
    border-radius: 4px;
    background-color: white;
    box-shadow: 0 1px 3px 0 #e6ebf1;
    transition: box-shadow 150ms ease;
}

.StripeElement--focus {
    box-shadow: 0 1px 3px 0 #cfd7df;
}

.StripeElement--invalid {
    border-color: #fa755a;
}

.StripeElement--webkit-autofill {
    background-color: #fefde5 !important;
}
</style>
{% endblock %}
